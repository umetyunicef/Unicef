<!DOCTYPE html>
<html>
<head>
  <title>UNICEF Schema Pagination</title>
  <style>
   *{ margin: 0px; padding: 0px; box-sizing: border-box; font-family: Verdana, Geneva, Tahoma, sans-serif;}
    #userList { width: 100%; box-shadow: 0 2px 4px #eee; border-radius: 4px; overflow: hidden; }
    #userList th{ background: #d3e0f0; padding: 10px 10px; font-size: 14px; border-bottom: 0px solid #eee; text-align: left; font-weight: 400;}
    #userList td{border-bottom: 0px solid #eee; padding: 10px 10px; font-size: 14px; }
    .fullbox{ width: 100%; padding: 40px 100px 10px 100px}
    .fullbox h1{ font-size: 20px; padding: 0 0 20px 0;}
    .paginationDiv{ padding: 20px 0 0 0; width: 100%; display: flex; justify-content: space-between; }
    #userList tr:nth-child(2n) td{background: #f4f8fe}
    .paginationDiv aside button{ background: skyblue; border: 0px; border-radius: 8px; font-weight: 500; padding: 10px 20px; margin: 0 0 0 15px; cursor: pointer;}
    #records{ font-size: 12px;}
    .serchDiv{ width: 250px; margin: 0 0 20px 0;  }
    .serchDiv input{ width: 100%; height: 35px; padding: 0 20px; border-radius: 4px; border: 1px solid #ddd; }
  </style>
</head>
<body>
    <div class="fullbox">
  <h1>UNICEF Schema</h1>
  <div class="serchDiv">
    <input type="text" id="searchInput" placeholder="Search by name">
  </div>
  
  <table border="0" cellpadding="0" cellspacing="0" id="userList">
      <thead>
        <th onclick="sortTable(0)">Name <span></span></th>
        <th onclick="sortTable(1)">Gender <span></span></th>
        <th onclick="sortTable(2)">Age <span></span></th>
        <th onclick="sortTable(3)">Grade <span></span></th>
        <th onclick="sortTable(4)">Country <span></span></th>
        <th onclick="sortTable(5)">Score <span></span></th>
        <th onclick="sortTable(6)">Attempted On <span>&#x25B2;</span></th>
    </thead>
    <tbody>

    </tbody>
    <!-- User data will be added here dynamically -->
  </table>

  <div class="paginationDiv">
    <p id="records"></p>
    <aside>
        <button class="pbtn" id="prevBtn" disabled>Previous</button>
        <button class="pbtn" id="nextBtn">Next</button>
    </aside>
  </div>
</div>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
  <script>
    // Initialize Firebase
    const firebaseConfig = {
        apiKey: "AIzaSyB1bjWm3FV06EzaONxURAPOxcd34Fzp0W0",
        authDomain: "unicef-e6d80.firebaseapp.com",
        databaseURL: "https://unicef-e6d80-default-rtdb.asia-southeast1.firebasedatabase.app",
        projectId: "unicef-e6d80",
        storageBucket: "unicef-e6d80.appspot.com",
        messagingSenderId: "745647732927",
        appId: "1:745647732927:web:a7bde58a2d527fdae3ae0a",
        measurementId: "G-MNT48P4Z7X"
    };

    firebase.initializeApp(firebaseConfig);
 // Constants for pagination
    const PAGE_SIZE = 20;
    let lastItemKey = null;
    let firstItemKey = null;
    let currentPage = 1;
    let totalRecords = 0;
    let currentPageRecords = 0;
    let sortOrder = 1;

    function fetchNextUsers(page, searchTerm, sortBy) {
      getTotalRecords(searchTerm);
      const userList = document.querySelector("#userList tbody");
      userList.innerHTML = "";

      const dbRef = firebase.database().ref('UNICEF');

      var sortByMapping= ["name","gender","age","grade","country","score","created_on"];
      var sortByColumnName = sortByMapping[sortBy];
      // console.log("sortByColumnName = ",sortByColumnName);
      if (currentPage > 1) {
        query = dbRef.orderByChild(sortByColumnName).startAt(lastItemKey).limitToFirst(PAGE_SIZE + 1);
      } else {
        query = dbRef.orderByChild(sortByColumnName).limitToFirst(PAGE_SIZE);
      }

      if (searchTerm) {
        query = dbRef.orderByChild('name').startAt(searchTerm).endAt(searchTerm + '\uf8ff');
      }

      query.once("value")
        .then((snapshot) => {
          const users = snapshot.val();
          let userCount = 0;

          let sortedUsers = [];
          snapshot.forEach((childSnapshot) => {
            sortedUsers.push(childSnapshot.val());
          });

          // Sort the data based on the selected column
          if (sortBy === 0) {
            sortedUsers.sort((a, b) => {
              const nameA = a.name?.toLowerCase();
              const nameB = b.name?.toLowerCase();
              if (nameA < nameB) return -sortOrder;
              if (nameA > nameB) return -sortOrder;
              return 0;
            });
          } 
          else if(sortBy === 1){
            sortedUsers.sort((a,b) => {
              const genderA = a.gender?.toLowerCase();
              const genderB = b.gender?.toLowerCase();
              if(genderA < genderB) return -sortOrder;
              if(genderA > genderB) return -sortOrder;
              return 0;
            })
          }
          else if(sortBy === 2){
            sortedUsers.sort((a,b) => {
              const ageA = a.age;
              const ageB = b.age;
              return sortOrder * (ageA - ageB);
            })
          }
          else if(sortBy === 3){
            sortedUsers.sort((a,b) => {
              const gradeA = a.grade;
              const gradeB = b.grade;
              return sortOrder * (gradeA - gradeB) ;
            })
          }
          else if (sortBy === 4) {
            sortedUsers.sort((a,b) => {
              const countryA = a.country?.toLowerCase();
              const countryB = b.country?.toLowerCase();
              return sortOrder * (countryA > countryB);
            })
          }
          else if(sortBy === 5) {
            sortedUsers.sort((a,b) => {
              const scoreA = a.score;
              const scoreB = b.score;
              return sortOrder * (scoreA > scoreB);
            })
          }
          else if(sortBy === 6) {
            sortedUsers.sort((a, b) => {
              const dateA = new Date(a.created_on||'');
              const dateB = new Date(b.created_on || '');
              return sortOrder * (dateA - dateB);
            });
          }

          sortedUsers.forEach((user) => {
            const li = document.createElement("tr");
            li.innerHTML = `<td>${user.name}</td> <td>${user.gender}</td> <td>${user.age}</td> <td>${user.grade}</td> <td>${user.country}</td> <td>${user.score}</td> <td>${convertUnixToDate(user.created_on)}</td>`;

            if (userCount != 0 || currentPage === 1) {
              userList.appendChild(li);
            }

            if (currentPage === 1 && userCount <= PAGE_SIZE - 1) {
              lastItemKey = searchTerm ? user.name : user.created_on;
            } else if (userCount === PAGE_SIZE) {
              lastItemKey = searchTerm ? user.name : user.created_on;
            }

            if (currentPage !== 1 && userCount === 1) {
              firstItemKey = searchTerm ? user.name : user.created_on;
            }

            userCount++;
            currentPageRecords = userCount;
          });

          document.getElementById("prevBtn").disabled = currentPage === 1;
          document.getElementById("nextBtn").disabled = currentPage == Math.ceil(totalRecords / PAGE_SIZE);
          updatedRecords(currentPage, currentPageRecords, totalRecords, PAGE_SIZE);
        })
        .catch((error) => {
          console.error("Error getting users:", error);
        });
    }

    function convertUnixToDate(timestamp) {
            const dateObj = new Date(timestamp * 1000); // Convert Unix timestamp to milliseconds
            const year = dateObj.getFullYear();
            const month = String(dateObj.getMonth() + 1).padStart(2, "0"); // Months are zero-based, so we add 1
            const day = String(dateObj.getDate()).padStart(2, "0");
            const hour = String(dateObj.getHours()).padStart(2,"0");
            const minute = String(dateObj.getMinutes()).padStart(2,"0");
            const seconds = String(dateObj.getSeconds()).padStart(2,"0");

            return `${year}-${month}-${day} ${hour}:${minute}:${seconds}`;
        }

    // Function to handle the "Next" button click
    document.getElementById("nextBtn").addEventListener("click", () => {
      currentPage++;
      fetchNextUsers(currentPage, document.getElementById("searchInput").value.trim(), sortOrder);
    });

    // Function to handle the "Previous" button click
    document.getElementById("prevBtn").addEventListener("click", () => {
      if (currentPage > 1) {
        currentPage--;
        lastItemKey = null; // Reset lastItemKey to load previous page from the beginning
        fetchNextUsers(currentPage, document.getElementById("searchInput").value.trim(), sortOrder);
        updatedRecords(currentPage, currentPageRecords, totalRecords, PAGE_SIZE);
      }
    });

    // Function to fetch the total number of records
    async function getTotalRecords(searchTerm) {
      if(!searchTerm){
        const dbRef = firebase.database().ref('UNICEF');
        const data = await dbRef.once("value");
        totalRecords = data.numChildren();
        document.getElementById("nextBtn").disabled = currentPage == Math.ceil(totalRecords / PAGE_SIZE);
        updatedRecords(currentPage, currentPageRecords, totalRecords, PAGE_SIZE);
      }
    }

    // Function to update the pagination information
    function updatedRecords(currentPage, currentPageRecords, totalRecords, PAGE_SIZE){
      document.getElementById("records").innerText = `Page ${currentPage} of ${Math.ceil(totalRecords / PAGE_SIZE)}`;
    }

    // Search functionality
    document.getElementById("searchInput").addEventListener("keyup", () => {
      const searchTerm = document.getElementById("searchInput").value.trim();
      currentPage = 1;
      lastItemKey = null;
      fetchNextUsers(currentPage, searchTerm, sortOrder);
    });

    function showArrowOnColumn(sortBy, sortOrder){
      // Get the target table
      const table = document.getElementById('userList');

      // Find the ith <th> element
      const thElements = table.querySelectorAll('th');
      for(let i=0;i<thElements.length;i++){
        const spanElement = thElements[i].querySelector('span');
        spanElement.textContent = "";
      }
      const ithTh = thElements[sortBy];
      // Create a <span> element
      const spanElement = ithTh.querySelector('span');
      // Set the content of the <span> (you can change this as per your requirement)
      spanElement.textContent = sortOrder>0 ? "\u25B2" : "\u25BC";
      // Append the <span> tag inside the ith <th> element
      ithTh.appendChild(spanElement);
    }

    // Function to handle the sorting of the table
    function sortTable(columnIndex) {
      sortOrder *= -1;
      showArrowOnColumn(columnIndex ,sortOrder);
      fetchNextUsers(currentPage, document.getElementById("searchInput").value.trim(), columnIndex);
    }

    // Initial fetch on page load
    fetchNextUsers(currentPage, document.getElementById("searchInput").value.trim(), sortOrder);
  </script>
</body>
</html>
